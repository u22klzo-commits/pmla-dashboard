generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  username     String?  @unique
  passwordHash String
  role         Role     @default(VIEWER)
  isApproved   Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  ownedCases         Case[]   @relation("CaseOwner")
  collaboratingCases Case[]   @relation("CaseCollaborators")
}

model Case {
  id          String   @id @default(uuid())
  title       String
  caseNumber  String   @unique
  description String?
  status      String?  @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  searches      Search[]
  ownerId       String?
  owner         User?    @relation("CaseOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  collaborators User[]   @relation("CaseCollaborators")
}

model Search {
  id        String       @id @default(uuid())
  caseId    String
  name      String
  status    SearchStatus @default(PLANNED)
  date      DateTime
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  premises  Premise[]
  resources Resource[]
  case      Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}

model Premise {
  id                   String               @id @default(uuid())
  searchId             String
  name                 String
  address              String
  locationType         LocationType
  nature               PremiseNature
  occupantName         String?
  mobileNumber         String?
  sourceOfInfo         SourceOfInfo?
  gpsLat               Float?
  gpsLong              Float?
  distanceFromCrpfCamp Float?
  liveLocationUrl1     String?
  liveLocationUrl2     String?
  photoUrl             String?
  recceStatus          RecceStatus          @default(PENDING)
  recceNotes           String?
  decisionStatus       DecisionStatus       @default(PENDING)
  allocationStatus     AllocationStatus     @default(PENDING)
  requirements         Json?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  search               Search               @relation(fields: [searchId], references: [id], onDelete: Cascade)
  assignedResources    ResourceAllocation[]

  @@index([searchId])
}

model Resource {
  id              String               @id @default(uuid())
  type            ResourceType
  name            String
  gender          Gender               @default(MALE)
  rank            OfficialRank?
  contactNumber   String?
  address         String?
  area            String?
  idType          IdType?
  idNumber        String?
  designation     String?
  unit            String?
  remarks         String?
  licenseNumber   String?
  vehicleType     String?
  vehicleRegNo    String?
  crpfMaleCount   Int?
  crpfFemaleCount Int?
  details         String?
  status          ResourceStatus       @default(AVAILABLE)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  searchId        String?
  search          Search?              @relation(fields: [searchId], references: [id], onDelete: Cascade)
  allocations     ResourceAllocation[]

  @@index([type])
  @@index([status])
  @@index([searchId, status])
  @@index([searchId, type])
  @@index([name])
}

model ResourceAllocation {
  id         String   @id @default(uuid())
  premiseId  String
  resourceId String
  assignedAt DateTime @default(now())
  premise    Premise  @relation(fields: [premiseId], references: [id], onDelete: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([premiseId, resourceId])
}

model FieldConfig {
  id         String  @id @default(uuid())
  viewName   String
  fieldName  String
  isRequired Boolean @default(false)
  isVisible  Boolean @default(true)

  @@unique([viewName, fieldName])
}

enum Role {
  ADMIN
  COMMANDER
  OFFICER
  VIEWER
}

enum SearchStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

enum LocationType {
  KOLKATA
  OUTSIDE
}

enum PremiseNature {
  RESIDENTIAL
  COMMERCIAL
  OFFICE
  INDUSTRIAL
  OTHERS
}

enum RecceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  COULD_NOT_LOCATE
}

enum DecisionStatus {
  PENDING
  APPROVED
  REJECTED
  ON_HOLD
}

enum AllocationStatus {
  PENDING
  DONE
}

enum ResourceType {
  WITNESS
  DRIVER
  OFFICIAL
  CRPF
}

enum SourceOfInfo {
  INFORMER
  COMPLAINT
  INTELLIGENCE
  OTHER
}

enum IdType {
  AADHAAR
  VOTER_ID
  PAN
  OTHER
}

enum ResourceStatus {
  AVAILABLE
  ASSIGNED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum OfficialRank {
  AEO
  EO
  AD
  DSP
  INSPECTOR
  SI
  ASI
  HC
  CONSTABLE
  OTHER
}
